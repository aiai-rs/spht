<!DOCTYPE html>
<html lang="zh-CN">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" href="/manifest.json">
Â  Â  <title>NEXUS ADMIN | æ€»æ§</title>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>Â 
Â  Â  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
Â  Â  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* ... */
        * {
            box-sizing: border-box;
        }
        
        body { 
            margin: 0; 
            background: #f8fafc; 
            color: #334155; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        .sidebar { 
            width: 240px; 
            background: #ffffff; 
            border-right: 1px solid #e2e8f0; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            z-index: 100;
        }
        
        .logo { 
            font-size: 20px; 
            font-weight: bold; 
            color: #0ea5e9; 
            margin-bottom: 40px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .menu-item { 
            padding: 12px 15px; 
            cursor: pointer; 
            border-radius: 8px; 
            margin-bottom: 5px; 
            color: #64748b; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: 0.2s; 
            font-size: 14px;
            font-weight: 500;
        }
        
        .menu-item:hover, .menu-item.active { 
            background: #f1f5f9; 
            color: #0f172a; 
        }
        
        .menu-item i {
            font-size: 18px;
            width: 24px;
        }
        
        .main { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
            background: #f8fafc; 
        }
        
        .page { 
            display: none; 
            animation: fadeIn 0.3s ease;
        } 
        
        .page.active { 
            display: block; 
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card { 
            background: #ffffff; 
            border-radius: 12px; 
            padding: 25px; 
            border: 1px solid #e2e8f0; 
            margin-bottom: 20px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
        }
        
        h2 { 
            margin-top: 0; 
            color: #0ea5e9; 
            font-size: 18px; 
            border-bottom: 1px solid #e2e8f0; 
            padding-bottom: 10px; 
        }
        
        input, textarea, select { 
            width: 100%; 
            background: #ffffff; 
            border: 1px solid #cbd5e1; 
            color: #334155; 
            padding: 12px; 
            border-radius: 8px; 
            margin: 5px 0 15px 0; 
            box-sizing: border-box; 
            font-size: 14px;
            transition: 0.2s;
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: #0ea5e9; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); 
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            cursor: pointer;
        }
        
        button { 
            background: linear-gradient(to right, #0ea5e9, #3b82f6); 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            color: white; 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.3s; 
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover { 
            opacity: 0.9; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        } 
        
        button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #64748b;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-warning {
            background: #f59e0b;
        }
        
        .chat-list-item { 
            padding: 12px; 
            border-bottom: 1px solid #e2e8f0; 
            cursor: pointer; 
            font-size: 14px; 
            transition: 0.2s;
        }
        
        .chat-list-item:hover { 
            background: #f1f5f9; 
        }
        
        .chat-list-item.active {
            background: #e0f2fe;
            border-left: 3px solid #0ea5e9;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            background: white; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0;
        }
        
        th, td { 
            text-align: left; 
            padding: 14px; 
            border-bottom: 1px solid #e2e8f0; 
            font-size: 13px; 
            vertical-align: top; 
        }
        
        th { 
            background: #f8fafc; 
            color: #64748b; 
            font-weight: 600; 
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .tag { 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 500;
            display: inline-block;
        }
        
        .tag.paid { 
            background: rgba(16,185,129,0.1); 
            color: #047857; 
        }
        
        .tag.wait { 
            background: rgba(245,158,11,0.1); 
            color: #b45309; 
        }
        
        .tag.cancelled {
            background: rgba(100, 116, 139, 0.1);
            color: #475569;
        }
        
@media (max-width: 768px) {
            body { 
                flex-direction: column; 
                overflow: auto; 
                height: auto; 
                padding-bottom: 70px; 
            }
            
           .sidebar {
                position: fixed;
                bottom: 30px; /* è·ç¦»åº•éƒ¨æ‚¬æµ® */
                left: 50%;
                transform: translateX(-50%); /* ç»å¯¹å±…ä¸­ */
                width: 95%;
                max-width: 500px;
                height: 72px; /* é«˜åº¦é€‚ä¸­ */
                
                background: rgba(255, 255, 255, 0.85); /* åŠé€æ˜èƒŒæ™¯ */
                backdrop-filter: blur(20px); /* æ¯›ç»ç’ƒæ•ˆæœ */
                -webkit-backdrop-filter: blur(20px);
                
                border: 1px solid rgba(255, 255, 255, 0.5);
                border-radius: 100px; /* èƒ¶å›Šå½¢çŠ¶ */
                
                /* æ ¸å¿ƒä¿®æ­£ï¼šå¼ºåˆ¶æ¨ªå‘æ’åˆ— */
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between;
                align-items: center;
                
                padding: 0 10px;
                z-index: 9999;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15); /* æ‚¬æµ®é˜´å½± */
            }

            .logo {
                display: none;
            }

            .menu-item {
                font-size: 10px; /* å­—ä½“å°ä¸€ç‚¹ä»¥å®¹çº³6ä¸ª */
                padding: 0;
                height: 100%;
                flex: 1; /* 6ä¸ªå›¾æ ‡å¹³åˆ†å®½åº¦ */
                border-radius: 0;
                
                /* å›¾æ ‡å’Œæ–‡å­—å‚ç›´æ’åˆ— */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                
                gap: 3px;
                background: transparent !important;
                color: #8e8e93; /* iOS é»˜è®¤ç° */
                margin: 0;
                white-space: nowrap;
            }

            .menu-item i {
                font-size: 24px; /* å›¾æ ‡å¤§ä¸€ç‚¹ */
                width: auto;
                margin-bottom: 0;
                display: block;
            }

            .menu-item.active {
                color: #007aff; /* iOS æ¿€æ´»è“ */
                background: transparent !important;
                font-weight: 500;
                transform: translateY(-2px); /* é€‰ä¸­å¾®åŠ¨æ•ˆ */
                transition: all 0.2s;
            }
            
            .menu-item i { 
                font-size: 20px; 
                width: auto;
                margin-bottom: 2px;
                display: block;
            }
            
            .main { 
                padding: 15px; 
            }

            /* è®¢å•åˆ—è¡¨å¡ç‰‡åŒ–é€‚é… (ä¿æŒä¸å˜) */
            #order-table thead { display: none; }
            #order-table tbody, #order-table tr, #order-table td { display: block; width: 100%; }
            #order-table tr {
                background: white;
                margin-bottom: 15px;
                border-radius: 12px;
                border: 1px solid #e2e8f0;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                padding: 10px;
            }
            #order-table td {
                padding: 8px 0;
                border-bottom: 1px dashed #f1f5f9;
                text-align: left;
            }
            #order-table td:last-child { border-bottom: none; }
        }

        .hire-item { 
            border: 1px solid #e2e8f0; 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            position: relative; 
            background: #f8fafc; 
        }
        
        .hire-del { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            color: #ef4444; 
            cursor: pointer; 
            background: #fee2e2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .hire-del:hover {
            background: #fecaca;
        }
        
        .img-list { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            margin-top: 5px; 
        }
        
        .img-preview-box { 
            width: 80px; 
            height: 80px; 
            position: relative; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid #e2e8f0; 
        }
        
        .img-preview-box img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .img-preview-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }
        
        .img-preview-remove:hover {
            background: #dc2626;
        }

        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 9999; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
        }
        
        .prod-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #f8fafc; 
            padding: 12px 15px; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            transition: 0.2s;
        }
        
        .prod-row:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .action-btn { 
            padding: 6px 12px; 
            font-size: 12px; 
            margin-left: 8px; 
            cursor: pointer; 
            border-radius: 6px; 
            border: none; 
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-edit { 
            background: #3b82f6; 
            color: white; 
        }
        
        .btn-del { 
            background: #ef4444; 
            color: white; 
        }
        
        .btn-pin { 
            background: #eab308; 
            color: #000; 
        }
        
       /* èŠå¤©çª—å£ Telegram é£æ ¼é‡æ„ */
        .chat-container { 
            position: relative;
            height: calc(100vh - 100px); /* æ’‘æ»¡å±å¹•é«˜åº¦ */
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
        }
        
        .chat-users-panel { 
            width: 320px;
            height: 100%;
            overflow-y: auto;
            background: #ffffff; 
            border-right: 1px solid #e2e8f0;
            flex-shrink: 0;
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chat-main-panel { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: #f0f2f5;
            height: 100%;
            position: relative;
            min-width: 0;
            z-index: 20;
        }

        .chat-header {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            flex-shrink: 0;
        }

        .chat-back-btn {
            display: none;
            font-size: 24px;
            color: #334155;
            cursor: pointer;
            padding: 5px;
        }

        .chat-messages { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }
        
        .chat-input-container {
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-input-container input {
            margin: 0;
            background: #f1f5f9;
            border: none;
            border-radius: 20px;
            padding: 12px 15px;
        }

        .chat-input-container input:focus {
            background: white;
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .chat-item {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8fafc;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }
        .chat-item:hover { background: #f8fafc; }
        .chat-item.active { background: #eff6ff; border-left: 3px solid #3b82f6; }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-info { flex: 1; min-width: 0; }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-weight: 600; color: #1e293b; font-size: 15px; }
        .chat-time { font-size: 11px; color: #94a3b8; }
        .chat-preview { font-size: 13px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .chat-badge { background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: bold; min-width: 20px; text-align: center; }

        .msg-row { display: flex; width: 100%; }
        .msg-row.user { justify-content: flex-start; }
        .msg-row.admin { justify-content: flex-end; }

        .msg-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-row.user .msg-bubble { background: white; color: #1e293b; border-top-left-radius: 2px; }
        .msg-row.admin .msg-bubble { background: #3b82f6; color: white; border-top-right-radius: 2px; }
        .msg-time { font-size: 10px; text-align: right; margin-top: 4px; opacity: 0.7; }

        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 80px);
                border: none;
                border-radius: 0;
            }
            .chat-users-panel {
                width: 100%;
                position: absolute;
                left: 0; top: 0; bottom: 0;
                transform: translateX(0);
            }
            .chat-main-panel {
                width: 100%;
                position: absolute;
                left: 0; top: 0; bottom: 0;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
           .chat-container.active .chat-users-panel { transform: translateX(-20%); }
            .chat-container.active .chat-main-panel { transform: translateX(0); }
            .chat-back-btn { display: block; }
            
            /* ã€æ–°å¢ã€‘å½“èŠå¤©æ¿€æ´»æ—¶ï¼Œéšè—æ‚¬æµ®å¯¼èˆªæ ï¼Œé˜²æ­¢é®æŒ¡è¾“å…¥æ¡† */
            body:has(.chat-container.active) .sidebar {
                display: none !important;
            }
            /* ã€æ–°å¢ã€‘è°ƒæ•´é«˜åº¦ä¸ºåŠ¨æ€è§†è§‰é«˜åº¦ï¼Œé˜²æ­¢é”®ç›˜å¼¹å‡ºæ—¶é®æŒ¡ */
            .chat-container.active {
                height: 100dvh !important;
                width: 100vw !important;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 10001;
                background: white;
                display: flex !important;
            }
        }
        
        /* äºŒç»´ç ä¸Šä¼ æ ·å¼ */
        .qrcode-upload { 
            background: #f0f9ff; 
            padding: 15px; 
            border-radius: 10px; 
            margin-top: 10px; 
            border: 1px solid #bae6fd; 
        }
        
        .qrcode-preview { 
            max-width: 150px; 
            height: auto; 
            margin-top: 10px; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
        }
        
        /* ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
       .user-list {
            /* æ‰‹æœºç«¯é€‚é…ï¼šæ€»é«˜åº¦å‡å»é¡¶éƒ¨å¯¼èˆªå’Œæœç´¢æ çš„å¤§æ¦‚é«˜åº¦ */
            height: calc(100vh - 220px); 
            overflow-y: auto;
            /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œé˜²æ­¢æœ€åä¸€ä¸ªå…ƒç´ è¢«é®æŒ¡ */
            padding-bottom: 50px; 
        }
        
        .user-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-item:hover {
            background: #f8fafc;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-id {
            font-family: monospace;
            font-size: 12px;
            color: #64748b;
        }
        
        .user-contact {
            font-weight: 500;
            color: #334155;
            margin-bottom: 4px;
        }
        
        .user-balance {
            color: #10b981;
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-date {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* é€šçŸ¥æ ·å¼ */
        .admin-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid #0ea5e9;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .admin-notification.success {
            border-left-color: #10b981;
        }
        
        .admin-notification.warning {
            border-left-color: #f59e0b;
        }
        
        .admin-notification.danger {
            border-left-color: #ef4444;
        }
        
        .admin-notification-icon {
            font-size: 20px;
        }
        
        .admin-notification.success .admin-notification-icon {
            color: #10b981;
        }
        
        .admin-notification.warning .admin-notification-icon {
            color: #f59e0b;
        }
        
        .admin-notification.danger .admin-notification-icon {
            color: #ef4444;
        }
        
        .admin-notification-content {
            flex: 1;
        }
        
        .admin-notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #334155;
        }
        
        .admin-notification-message {
            font-size: 13px;
            color: #64748b;
            line-height: 1.4;
        }
        
        .admin-notification-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .admin-notification-close:hover {
            background: #f3f4f6;
            color: #64748b;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ ç¾åŒ– */
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            color: #64748b;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }
        
        .file-upload-label:hover {
            background: #f1f5f9;
            border-color: #94a3b8;
        }
        
        .file-upload-label i {
            font-size: 24px;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #0ea5e9;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 13px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* åˆ†é¡µå™¨ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 30px;
            padding: 20px 0;
        }
        
        .page-btn {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            color: #334155;
            font-size: 14px;
            transition: 0.2s;
        }
        
        .page-btn:hover:not(.active):not(:disabled) {
            background: #f3f4f6;
            border-color: #cbd5e1;
        }
        
        .page-btn.active {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: #334155;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>

<!-- é€šçŸ¥å®¹å™¨ -->
<div id="notification-container" style="position:fixed; top:20px; right:20px; z-index:10000;"></div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div id="login-modal" class="modal-overlay">
    <div class="card" style="width: 350px; text-align: center;">
        <h2 style="border:none; margin-top: 0;">ç®¡ç†å‘˜ç™»å½•</h2>
        <div class="form-group">
            <input id="admin-user" placeholder="ç”¨æˆ·å">
        </div>
        <div class="form-group">
            <input id="admin-pass" type="password" placeholder="å¯†ç ">
        </div>
        <button onclick="adminLogin()" style="width: 100%;">ç™»å½•</button>
    </div>
</div>

<!-- ä¸»ç•Œé¢ -->
<div class="sidebar">
    <div class="logo"><i class="ri-command-line"></i> NEXUS Admin</div>
    <div class="menu-item active" onclick="nav('dash')"><i class="ri-dashboard-line"></i> ä»ªè¡¨ç›˜</div>
    <div class="menu-item" onclick="nav('prod')"><i class="ri-shopping-cart-2-line"></i> å•†å“ç®¡ç†</div>
    <div class="menu-item" onclick="nav('order')"><i class="ri-list-check"></i> è®¢å•ç®¡ç†</div>
    <div class="menu-item" onclick="nav('users')"><i class="ri-user-line"></i> ç”¨æˆ·ç®¡ç†</div>
  <div class="menu-item" onclick="nav('hire')"><i class="ri-user-add-line"></i> æ‹›è˜ç®¡ç†</div>
    <div class="menu-item" onclick="nav('funds')"><i class="ri-money-cny-box-line"></i> èµ„é‡‘æ˜ç»†</div>
    <div class="menu-item" onclick="nav('chat')">
        <i class="ri-chat-1-line"></i> å®¢æœèŠå¤©
        <span id="chat-badge-total" class="nav-badge">0</span>
    </div>
</div>

<div class="main">
    <!-- ä»ªè¡¨ç›˜ -->
    <div id="dash" class="page active">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥è®¢å•</div>
                <div class="stat-value" id="today-orders">0</div>
                <div style="font-size:12px; color:#94a3b8;" id="today-amount">é‡‘é¢: 0 USDT</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¾…å¤„ç†è®¢å•</div>
                <div class="stat-value" id="pending-orders">0</div>
                <div style="font-size:12px; color:#94a3b8;">ç­‰å¾…æ”¯ä»˜/å¤„ç†</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                <div class="stat-value" id="total-users">0</div>
                <div style="font-size:12px; color:#94a3b8;">æ³¨å†Œç”¨æˆ·</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å•†å“æ€»æ•°</div>
                <div class="stat-value" id="total-products">0</div>
                <div style="font-size:12px; color:#94a3b8;">åœ¨å”®å•†å“</div>
            </div>
        </div>
 
<p style="color: #64748b; font-size: 14px;">å½“å‰æ±‡ç‡: <span id="cur-rate" style="font-weight:bold;">--</span> | æ‰‹ç»­è´¹: <span id="cur-fee" style="font-weight:bold;">--</span>%</p>       
<div class="form-group">
                <label>å…¨ç«™å…¬å‘Šå†…å®¹</label>
                <textarea id="ann-text" rows="5" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..."></textarea>
            </div>
            
            <div class="form-group">
                <label style="font-weight:bold; color:#0ea5e9;">å¼¹çª—é¢‘ç‡è®¾ç½® (ç”¨æˆ·è®¿é—®æ—¶å¤šä¹…å¼¹ä¸€æ¬¡)</label>
                <select id="ann-pop" style="margin-top:5px;">
                    <option value="false">ğŸš« å…³é—­å¼¹çª—</option>
                    <option value="86400000">ğŸ“… ä¸€å¤© (24å°æ—¶)</option>
                    <option value="172800000">ğŸ“… ä¸¤å¤©</option>
                    <option value="259200000">ğŸ“… ä¸‰å¤©</option>
                    <option value="604800000">ğŸ“… ä¸€ä¸ªæ˜ŸæœŸ</option>
                    <option value="2592000000">ğŸ“… ä¸€ä¸ªæœˆ</option>
                    <option value="31536000000">ğŸ“… ä¸€å¹´</option>
                </select>
            </div>

            <button onclick="updAnn(this)"><i class="ri-save-line"></i> æ›´æ–°è®¾ç½®</button>
        </div>
    </div>

    <!-- å•†å“ç®¡ç† -->
    <div id="prod" class="page">
        <div class="card">
            <h2 id="prod-title"><i class="ri-add-circle-line"></i> ä¸Šæ¶æ–°å•†å“</h2>
            <input type="hidden" id="p-id">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>å•†å“åç§°</label>
                    <input id="p-name" placeholder="ä¾‹å¦‚ï¼šé«˜çº§VPNè´¦å·">
                </div>
                <div class="form-group">
                    <label>ä»·æ ¼ (USDT)</label>
                    <input id="p-price" placeholder="ä¾‹å¦‚ï¼š10.5">
                </div>
                <div class="form-group">
                    <label>åº“å­˜</label>
                    <input id="p-stock" type="number" placeholder="ä¾‹å¦‚ï¼š100">
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <input id="p-cat" placeholder="ä¾‹å¦‚ï¼šVPNã€è´¦å·ã€æœåŠ¡">
                </div>
<div class="form-group">
                    <label>å•†å“ç±»å‹</label>
                    <select id="p-type">
                        <option value="virtual">âš¡ è™šæ‹Ÿå•†å“</option>
                        <option value="physical">ğŸ“¦ å®ç‰©å•†å“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å•†å“å›¾ç‰‡ (æ”¯æŒå¤šå¼ )</label>
                    <div class="file-upload">
                        <input type="file" id="p-file" onchange="uploadImg(this)" accept="image/png,image/jpeg,image/gif,image/webp,image/jpg">
                        <div class="file-upload-label">
                            <i class="ri-image-add-line"></i>
                            <span>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                        </div>
                    </div>
                    <div id="p-img-list" class="img-list"></div>
                    <p style="font-size:12px; color:#94a3b8; margin-top:5px;">æ”¯æŒ JPEG, PNG, GIF, WebP æ ¼å¼ï¼Œæœ€å¤§10MB</p>
                </div>
            </div>
            
            <div class="form-group">
                <label>è¯¦ç»†æè¿°</label>
                <textarea id="p-desc" rows="3" placeholder="å•†å“è¯¦ç»†æè¿°..."></textarea>
            </div>
            
<div style="display: flex; gap: 10px;">
                <button id="btn-save-prod" onclick="saveProd(this)"><i class="ri-check-line"></i> ä¸Šæ¶å•†å“</button>
                <button id="btn-cancel-edit" onclick="resetProdForm()" style="background: #94a3b8; display: none;"><i class="ri-close-line"></i> å–æ¶ˆç¼–è¾‘</button>
            </div>
        </div>

        <div class="card">
            <h2><i class="ri-sort-asc"></i> åˆ†ç±»æ’åº (æ•°å­—è¶Šå¤§è¶Šé å‰)</h2>
            <div id="cat-sort-list" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            <div style="margin-top:10px; color:#94a3b8; font-size:12px;">æç¤ºï¼šä¿®æ”¹æ•°å€¼åè‡ªåŠ¨ä¿å­˜å¹¶ç”Ÿæ•ˆã€‚</div>
        </div>

        <div class="card">
            <h2><i class="ri-list-settings-line"></i> å·²ä¸Šæ¶å•†å“ç®¡ç†</h2>
            <div id="prod-list-manage"></div>
        </div>
    </div>

    <!-- è®¢å•ç®¡ç† -->
    <div id="order" class="page">
        <div class="card">
            <h2><i class="ri-list-check"></i> è®¢å•åˆ—è¡¨</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="order-search" placeholder="æœç´¢è®¢å•ç¼–ç ..." style="flex:1;" onkeyup="searchOrders()">
                <select id="order-filter" onchange="filterOrders()">
                    <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="pending">å¾…æ”¯ä»˜</option>
                    <option value="paid">å·²æ”¯ä»˜</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                </select>
            </div>
            
            <div id="order-loading" style="text-align:center; padding:20px;">
                <div class="loader" style="margin:0 auto;"></div>
                <div style="color:#94a3b8; margin-top:10px;">åŠ è½½è®¢å•ä¸­...</div>
            </div>
            
<table id="order-table">
                <thead>
                    <tr>
                        <th>æ¥æº/ç¼–ç </th>
                        <th>å•†å“/æ•°é‡/é‡‘é¢</th>
                        <th>ç”¨æˆ·/è”ç³»æ–¹å¼</th>
                        <th>æ”¯ä»˜/çŠ¶æ€</th>
                        <th>è¯¦æƒ…/å‘è´§</th>
                    </tr>
                </thead>
                <tbody id="order-list"></tbody>
            </table>
            
            <div class="pagination" id="order-pagination" style="display: none;">
                <button class="page-btn" onclick="changeOrderPage(-1)" id="order-prev">ä¸Šä¸€é¡µ</button>
                <span style="padding:8px 16px; color:#64748b;" id="order-page-info">ç¬¬1é¡µ</span>
                <button class="page-btn" onclick="changeOrderPage(1)" id="order-next">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç† -->
    <div id="users" class="page">
        <div class="card">
            <h2><i class="ri-user-line"></i> ç”¨æˆ·ç®¡ç†</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="color: #64748b; font-size: 14px;">å…± <span id="user-count" style="font-weight:bold;">0</span> ä¸ªç”¨æˆ·</div>
                <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·..." style="width: 200px;" onkeyup="searchUsers()">
            </div>
            
            <div class="user-list" id="user-list">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- æ‹›è˜ç®¡ç† -->
    <div id="hire" class="page">
        <div class="card">
            <h2><i class="ri-user-add-line"></i> æ‹›è˜ä¿¡æ¯é…ç½®</h2>
            <div id="h-list-container"></div>
            <button onclick="addHireItem()" style="background: #e2e8f0; color: #334155; margin-top: 10px;">
                <i class="ri-add-line"></i> æ·»åŠ èŒä½
            </button>
            <hr style="border-color: #e2e8f0; margin: 20px 0;">
           <button onclick="updHire(this)"><i class="ri-save-line"></i> ä¿å­˜æ‰€æœ‰æ‹›è˜ä¿¡æ¯</button>
        </div>
    </div>

   <div id="funds" class="page">
        <div class="card">
            <h2><i class="ri-money-cny-box-line"></i> ç”¨æˆ·èµ„é‡‘æ˜ç»† (æµæ°´)</h2>
            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <input type="text" id="fund-user-search" placeholder="è¾“å…¥ç”¨æˆ·UIDç­›é€‰..." style="margin:0; width: 200px;">
                <button onclick="loadBalanceLogs()" style="padding: 10px 15px;"><i class="ri-search-line"></i> æŸ¥è¯¢</button>
                <button onclick="document.getElementById('fund-user-search').value='';loadBalanceLogs()" style="padding: 10px 15px; background: #64748b;">é‡ç½®</button>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%;">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>ç”¨æˆ·</th>
                            <th>ç±»å‹</th>
                            <th>é‡‘é¢å˜åŠ¨</th>
                            <th>å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="fund-list">
                        <tr><td colspan="5" style="text-align:center;color:#94a3b8;">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å®¢æœèŠå¤© -->
   <div id="chat" class="page">
        <div class="chat-container" id="chat-wrapper">
            <div class="chat-users-panel">
                <div id="chat-users">
                    </div>
            </div>
            <div class="chat-main-panel">
                <div class="chat-header">
                    <i class="ri-arrow-left-line chat-back-btn" onclick="closeChatMobile()"></i>
                    <div style="font-weight:bold; font-size:16px;" id="chat-title-uid">é€‰æ‹©ä¼šè¯</div>
                </div>

                <div id="chat-box" class="chat-messages">
                    <div style="text-align:center; padding-top:100px; color:#94a3b8;">
                        <i class="ri-chat-smile-2-line" style="font-size:48px; opacity:0.5;"></i>
                        <div style="margin-top:10px;">ç‚¹å‡»å·¦ä¾§åˆ—è¡¨å¼€å§‹å¯¹è¯</div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input id="reply-in" type="text" style="flex:1;" placeholder="è¾“å…¥å›å¤..." onkeypress="if(event.key === 'Enter') reply(this)">
                    <button onclick="reply(this)" style="padding:10px; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                        <i class="ri-send-plane-fill" style="font-size:18px; margin:0;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // æ³¨å†Œ PWA æœåŠ¡
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js');
        });
    }

Â  Â  const API_BASE = "https://api.xaw888.com";;Â 
const socket = io(API_BASE);
    
    // é˜²XSSè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
        if (!text) return text;
        return text.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
   let curData = {}, curChat = null;
    let tempImgs = [];
    let searchTimer = null; // æ–°å¢é˜²æŠ–å®šæ—¶å™¨
    let adminToken = localStorage.getItem('adminToken');
    let currentOrderPage = 1;
    let ordersPerPage = 10;
    let totalOrderPages = 1;

    // åˆå§‹åŒ–æ£€æŸ¥
    if(adminToken) {
        document.getElementById('login-modal').style.display = 'none';
    } else {
        document.getElementById('login-modal').style.display = 'flex';
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(title, message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `admin-notification ${type}`;
        notification.innerHTML = `
            <div class="admin-notification-icon">
                ${type === 'success' ? 'âœ“' : type === 'warning' ? 'âš ' : type === 'danger' ? 'âœ—' : 'â„¹'}
            </div>
            <div class="admin-notification-content">
                <div class="admin-notification-title">${title}</div>
                <div class="admin-notification-message">${message}</div>
            </div>
            <button class="admin-notification-close" onclick="this.parentElement.remove()">Ã—</button>
        `;
        
        container.appendChild(notification);
        
        // è‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    async function adminLogin() {
        const u = document.getElementById('admin-user').value;
        const p = document.getElementById('admin-pass').value;
        
        if (!u || !p) {
            showNotification('é”™è¯¯', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'danger');
            return;
        }
        
        try {
            const res = await fetch(`${API_BASE}/api/admin/login`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: u, password: p })
            });
            
            const d = await res.json();
            if(d.success) {
                adminToken = d.token;
                localStorage.setItem('adminToken', adminToken);
                document.getElementById('login-modal').style.display = 'none';
                showNotification('æˆåŠŸ', 'ç™»å½•æˆåŠŸ', 'success');
                refresh();
            } else {
                showNotification('é”™è¯¯', 'ç™»å½•å¤±è´¥: ' + d.msg, 'danger');
            }
        } catch(e) { 
            showNotification('é”™è¯¯', 'ç½‘ç»œè¿æ¥å¤±è´¥', 'danger');
            console.error('ç™»å½•é”™è¯¯:', e); 
        }
    }

    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': adminToken
        };
    }

    function nav(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // ã€æ–°å¢ã€‘å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œåˆ‡æ¢é¡µé¢æ—¶æ¢å¤ body çŠ¶æ€å¹¶å…³é—­èŠå¤©æ¿€æ´»æ€
        if(window.innerWidth <= 768) {
            document.body.style.overflow = 'auto';
            document.body.style.height = 'auto';
            const wrapper = document.getElementById('chat-wrapper');
            if(wrapper) wrapper.classList.remove('active');
        }

        if(event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
        
        // ã€æ–°å¢ã€‘åˆ‡æ¢é¡µé¢åè‡ªåŠ¨å›åˆ°é¡¶éƒ¨ï¼Œé˜²æ­¢å†…å®¹åœç•™åœ¨åº•éƒ¨
        window.scrollTo(0, 0);
        
        refresh();
    }

    // åˆ·æ–°æ•°æ®
    async function refresh() {
        if(!adminToken) return;
        
        // é˜²æ­¢åœ¨è¾“å…¥æ—¶åˆ·æ–°
        if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT')) {
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/api/admin/all`, { 
                headers: getAuthHeaders() 
            });
            
            if(res.status === 401) {
                localStorage.removeItem('adminToken');
                adminToken = null;
                document.getElementById('login-modal').style.display = 'flex';
                showNotification('é”™è¯¯', 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
                return;
            }
            
            curData = await res.json();

            // æ›´æ–°ä»ªè¡¨ç›˜ç»Ÿè®¡
            updateDashboardStats();
            
            // æ›´æ–°å…¬å‘Šè®¾ç½®
if(document.activeElement.id !== 'ann-text') {
                document.getElementById('ann-text').value = curData.announcement;
            }
            document.getElementById('cur-rate').innerText = curData.rate;
            document.getElementById('cur-fee').innerText = curData.feeRate || 0;
            
            // [ä¿®æ”¹] å›æ˜¾ select çš„å€¼ï¼Œå¦‚æœæ˜¯æ—§æ•°æ®(true/false)åˆ™ç»™ä¸ªé»˜è®¤å€¼
            let popVal = curData.popup;
            if(popVal === true || popVal === 'true') popVal = '86400000'; // å…¼å®¹æ—§æ•°æ®
            document.getElementById('ann-pop').value = popVal || 'false';

            // å•†å“ç®¡ç†
            if (document.getElementById('prod').classList.contains('active')) {
                renderProdManage(curData.products || []);
                renderCategorySort(); // [æ–°å¢] æ¸²æŸ“åˆ†ç±»æ’åº
            }

           // æ‹›è˜ç®¡ç†
            if (document.getElementById('hire').classList.contains('active')) {
                if(!document.getElementById('h-list-container').innerHTML.trim()) {
                   renderHireList(curData.hiring);
                }
            }
            
            // èµ„é‡‘æ˜ç»†
            if (document.getElementById('funds').classList.contains('active')) {
                loadBalanceLogs();
            }

            // è®¢å•ç®¡ç†
            if (document.getElementById('order').classList.contains('active')) {
                renderOrders();
            }
            
            // ç”¨æˆ·ç®¡ç†
            if (document.getElementById('users').classList.contains('active')) {
                renderUsers();
            }

            // èŠå¤©ç®¡ç†
            if (document.getElementById('chat').classList.contains('active')) {
                renderChats();
                if(curChat) openChat(curChat);
            }
        } catch (e) { 
            console.error('åˆ·æ–°æ•°æ®é”™è¯¯:', e);
            if (e.message.includes('Failed to fetch')) {
                showNotification('é”™è¯¯', 'ç½‘ç»œè¿æ¥å¤±è´¥', 'danger');
            }
        }
    }
    
    // æ›´æ–°ä»ªè¡¨ç›˜ç»Ÿè®¡
    function updateDashboardStats() {
        // ä»Šæ—¥è®¢å•
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todayOrders = curData.orders.filter(order => {
            const orderDate = new Date(order.created_at);
            return orderDate >= today;
        });
        
        document.getElementById('today-orders').textContent = todayOrders.length;
        
        const todayAmount = todayOrders.reduce((sum, order) => {
            return sum + parseFloat(order.usdt_amount || 0);
        }, 0);
        
        document.getElementById('today-amount').textContent = `é‡‘é¢: ${todayAmount.toFixed(2)} USDT`;
        
        // å¾…å¤„ç†è®¢å•
        const pendingOrders = curData.orders.filter(order => order.status === 'å¾…æ”¯ä»˜');
        document.getElementById('pending-orders').textContent = pendingOrders.length;
        
        // æ€»ç”¨æˆ·æ•°
        document.getElementById('total-users').textContent = curData.users?.length || 0;
        
        // å•†å“æ€»æ•°
        document.getElementById('total-products').textContent = curData.products?.length || 0;
    }
    
    // æ¸²æŸ“è®¢å•
    function renderOrders() {
        document.getElementById('order-loading').style.display = 'none';
        
        const orders = curData.orders || [];
        const searchTerm = document.getElementById('order-search').value.toLowerCase();
        const filterStatus = document.getElementById('order-filter').value;
        
        // è¿‡æ»¤è®¢å•
        let filteredOrders = orders;
        
        if (searchTerm) {
            filteredOrders = filteredOrders.filter(order => 
                order.order_id.toLowerCase().includes(searchTerm) ||
                (order.product_name && order.product_name.toLowerCase().includes(searchTerm)) ||
                (order.contact && order.contact.toLowerCase().includes(searchTerm))
            );
        }
        
        if (filterStatus !== 'all') {
            filteredOrders = filteredOrders.filter(order => {
                if (filterStatus === 'pending') return order.status === 'å¾…æ”¯ä»˜';
                if (filterStatus === 'paid') return order.status === 'å·²æ”¯ä»˜';
                if (filterStatus === 'cancelled') return order.status === 'å·²å–æ¶ˆ';
                return true;
            });
        }
        
        // åˆ†é¡µ
        totalOrderPages = Math.ceil(filteredOrders.length / ordersPerPage);
        const startIndex = (currentOrderPage - 1) * ordersPerPage;
        const endIndex = startIndex + ordersPerPage;
        const pageOrders = filteredOrders.slice(startIndex, endIndex);
        
        // æ¸²æŸ“è¡¨æ ¼
        document.getElementById('order-list').innerHTML = pageOrders.map(o => {
            const isPaid = o.status === 'å·²æ”¯ä»˜';
            let ship = null;
            try { 
                ship = JSON.parse(o.shipping_info); 
            } catch(e){}
            
            let addrHtml = '';
            if(ship && ship.name) {
                addrHtml = `
                <div style="background:#f1f5f9; padding:8px; border-radius:4px; margin-top:4px; font-size:12px; color:#475569;">
                    <div><i class="ri-user-line"></i> ${ship.name} | <i class="ri-phone-line"></i> ${ship.tel}</div>
                    <div><i class="ri-map-pin-line"></i> ${ship.addr}</div>
                </div>`;
            }

            let money = "";
            if(o.payment_method === 'USDT') {
                money = `${o.usdt_amount} USDT`;
            } else {
                money = `Â¥${o.cny_amount} CNY`;
            }
            
            const quantity = o.quantity || 1;
            const productName = o.product_name || 'æœªçŸ¥å•†å“';
            
            // æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯
            const user = curData.users?.find(u => u.id === o.user_id) || {};
            const userContact = user.contact || 'æœªçŸ¥ç”¨æˆ·';
            const userDisplayName = user.display_name || user.contact || 'æœªçŸ¥ç”¨æˆ·';

            let action = "";
            
            // å–æ¶ˆè®¢å•é€»è¾‘
            if(!isPaid && o.status !== 'å·²å–æ¶ˆ' && o.status !== 'å·²å…³é—­') {
                action += `
                    <button onclick="cancelOrderAdmin('${o.order_id}')" style="padding:8px 12px; font-size:12px; background:#ef4444; color:white; border:none; border-radius:6px; margin-bottom:8px; display:block; width:100%; cursor:pointer;">
                        <i class="ri-close-circle-line"></i> å–æ¶ˆè¯¥è®¢å•
                    </button>
                    <div style="font-size:12px; color:#64748b; margin-bottom:10px; background:#f1f5f9; padding:8px; border-radius:6px;">
                        <i class="ri-information-line"></i> ç¡®è®¤æ”¶æ¬¾è¯·åœ¨ç¾¤å†…æ“ä½œã€‚
                    </div>
                `;
            }

            // å¦‚æœè®¢å•æ˜¯å·²å–æ¶ˆçŠ¶æ€ï¼Œæ˜¾ç¤ºæç¤º
            if(o.status === 'å·²å–æ¶ˆ' || o.status.includes('å–æ¶ˆ')) {
                action += `
                    <div style="background:#fee2e2; color:#b91c1c; padding:10px; border-radius:6px; font-size:12px; margin-top:5px; border:1px solid #fecaca;">
                        <strong><i class="ri-error-warning-line"></i> è¯¥ç¬”è®¢å•å·²è¢«å®¢æœå–æ¶ˆ</strong><br>
                        å¦‚æœ‰ç–‘é—®è¯·è”ç³»å®¢æœ
                    </div>
                `;
            }

if(!isPaid && o.payment_method !== 'USDT' && o.status !== 'å·²å–æ¶ˆ') {
                action += `
                    <div style="margin-top:8px; border:1px dashed #cbd5e1; border-radius:8px; padding:10px; background:#f8fafc;">
                        <div style="font-size:12px; color:#64748b; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                            <span><i class="ri-qr-code-line"></i> æ”¶æ¬¾äºŒç»´ç </span>
                            ${o.qrcode_url ? '<span style="color:#10b981; font-size:10px;"><i class="ri-check-line"></i> å·²å­˜åœ¨</span>' : ''}
                        </div>
                        
                        <div style="display:flex; gap:5px;">
                            <input type="file" id="qrcode-${o.order_id}" accept="image/png,image/jpeg,image/gif,image/webp,image/jpg" style="display:none;" onchange="document.getElementById('btn-upload-${o.order_id}').click()">
                            
                            <button onclick="document.getElementById('qrcode-${o.order_id}').click()" style="flex:1; padding:8px; font-size:12px; background:white; color:#334155; border:1px solid #e2e8f0; border-radius:6px; box-shadow:none;">
                                <i class="ri-image-add-line"></i> é€‰æ‹©å›¾ç‰‡
                            </button>
                            
                            <button id="btn-upload-${o.order_id}" onclick="uploadQrcode('${o.order_id}', 'order')" style="display:none;"></button>
                        </div>

                        ${o.qrcode_url ? `
                            <div style="margin-top:8px; position:relative; width:60px; height:60px; border-radius:6px; overflow:hidden; border:1px solid #e2e8f0; cursor:pointer;" onclick="Swal.fire({imageUrl: '${o.qrcode_url}', showConfirmButton: false, background: 'transparent'})">
                                <img src="${o.qrcode_url}" style="width:100%; height:100%; object-fit:cover;">
                                <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.5); color:white; font-size:9px; text-align:center;">ç‚¹å‡»æŸ¥çœ‹</div>
                            </div>
                        ` : ''}
                    </div>`;
            }
            
            let trackHtml = `<div style="margin-top:5px; display:flex; gap:5px;">
                <input id="track-${o.order_id}" value="${o.tracking_number||''}" placeholder="è¾“å…¥ç‰©æµå•å·" style="padding:6px; margin:0; font-size:12px; flex:1;">
                <button onclick="saveTrack('${o.order_id}')" style="padding:6px 12px; font-size:12px;"><i class="ri-save-line"></i> ä¿å­˜</button>
            </div>`;

// ã€æ–°å¢ã€‘åˆ¤æ–­æ¥æºé¢œè‰²
            const sourceBadge = o.source && o.source.includes('8888') 
                ? '<span class="tag" style="background:#fef3c7; color:#d97706;">é¾å“¥</span>' 
                : '<span class="tag" style="background:#dbeafe; color:#2563eb;">Boss</span>';

            return `<tr>
                <td>
                    ${sourceBadge}
                    <div style="font-weight:500; font-family:monospace; margin-top:4px;">${o.order_id}</div>
                    <div style="color:#94a3b8; font-size:12px; margin-top:2px;">${new Date(o.created_at).toLocaleString()}</div>
                </td>
                <td>
                    <div style="font-weight:500;">${productName}</div>
                    <div style="color:#64748b; font-size:12px; margin-top:4px;">æ•°é‡: ${quantity}</div>
                    <div style="color:#334155; font-weight:bold; margin-top:4px;">${money}</div>
                </td>
                <td>
                    <div style="font-weight:500;">${escapeHtml(userDisplayName)}</div>
                    <div style="color:#64748b; font-size:12px; margin-top:4px;">${escapeHtml(userContact)}</div>
                    <div style="color:#94a3b8; font-size:11px; margin-top:4px;">ID: ${o.user_id || 'æœªçŸ¥'}</div>
                </td>
                <td>
                    <div style="font-weight:500;">${o.payment_method}</div>
                    <div style="margin-top:6px;"><span class="tag ${isPaid?'paid':'wait'}">${o.status}</span></div>
                </td>
                <td style="min-width: 250px;">
                    ${addrHtml}
                    ${trackHtml}
                    <div style="margin-top:8px;">${action}</div>
                </td>
            </tr>`;
        }).join('');
        
        // æ›´æ–°åˆ†é¡µå™¨
        const pagination = document.getElementById('order-pagination');
        const pageInfo = document.getElementById('order-page-info');
        const prevBtn = document.getElementById('order-prev');
        const nextBtn = document.getElementById('order-next');
        
        if (filteredOrders.length > ordersPerPage) {
            pagination.style.display = 'flex';
            pageInfo.textContent = `ç¬¬${currentOrderPage}/${totalOrderPages}é¡µ`;
            prevBtn.disabled = currentOrderPage === 1;
            nextBtn.disabled = currentOrderPage === totalOrderPages;
        } else {
            pagination.style.display = 'none';
        }
    }
    
   // æœç´¢è®¢å• (å·²åŠ é˜²æŠ–)
    function searchOrders() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
            currentOrderPage = 1;
            renderOrders();
        }, 300);
    }
    
    // è¿‡æ»¤è®¢å•
    function filterOrders() {
        currentOrderPage = 1;
        renderOrders();
    }
    
    // åˆ‡æ¢è®¢å•é¡µé¢
    function changeOrderPage(delta) {
        const newPage = currentOrderPage + delta;
        if (newPage >= 1 && newPage <= totalOrderPages) {
            currentOrderPage = newPage;
            renderOrders();
        }
    }
    
function renderUsers() {
        const users = curData.users || [];
        document.getElementById('user-count').textContent = users.length;
        
        const searchTerm = document.getElementById('user-search').value.toLowerCase();
        let filteredUsers = users;
        
        if (searchTerm) {
            filteredUsers = filteredUsers.filter(user => 
                (user.contact && user.contact.toLowerCase().includes(searchTerm)) ||
                (user.id && user.id.toString().includes(searchTerm))
            );
        }
        
       const userList = document.getElementById('user-list');
        userList.innerHTML = filteredUsers.map(user => {
            // åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦æœ‰è®¢å•
            const hasOrder = curData.orders && curData.orders.some(o => o.user_id == user.id); 
            
            // ã€æ–°å¢ã€‘åˆ¤æ–­ç”¨æˆ·æ¥æºè€æ¿ (ä¿®æ­£ fallback)
            const uSource = user.source || '';
            const sourceBadge = uSource.includes('8888') 
                ? '<span style="background:#fef3c7; color:#d97706; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:bold; border:1px solid #fbd38d;">é¾å“¥</span>' 
                : '<span style="background:#dbeafe; color:#2563eb; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:bold; border:1px solid #bfdbfe;">Boss</span>';

            return `
            <div class="user-item" style="align-items: flex-start;">
                <div class="user-info">
                    <div class="user-contact" style="font-weight:bold; font-size:16px; color:#1e293b; display:flex; align-items:center; gap:8px;">
                        ${sourceBadge} ${user.contact || 'æœªçŸ¥ç”¨æˆ·'}
                        ${hasOrder 
                            ? `<span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:100px; font-size:10px; font-weight:normal;">æœ‰ä¸‹å•</span>` 
                            : `<span style="background:#f1f5f9; color:#94a3b8; padding:2px 8px; border-radius:100px; font-size:10px; font-weight:normal;">æ— è®¢å•</span>`}
                    </div>
                    
                    <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:10px; font-size:12px; color:#64748b;">
                        <div style="background:#f8fafc; padding:2px 6px; border-radius:4px; border:1px solid #e2e8f0;">
                            <i class="ri-id-card-line"></i> UID: ${user.id}
                        </div>
                        ${user.invite_code ? `
                        <div style="background:#f0f9ff; color:#0284c7; padding:2px 6px; border-radius:4px; border:1px solid #bae6fd;">
                            <i class="ri-coupon-3-line"></i> ç : ${user.invite_code}
                        </div>` : ''}
                        ${user.invited_by ? `
                        <div style="background:#fff7ed; color:#ea580c; padding:2px 6px; border-radius:4px; border:1px solid #ffedd5;">
                            <i class="ri-share-forward-line"></i> ä¸Šçº¿: ${user.invited_by}
                        </div>` : ''}
                    </div>

                    <div style="margin-top:8px; font-family:monospace; font-size:14px; color:#334155;">
                        <span style="color:#94a3b8; font-family:-apple-system, sans-serif;">ä½™é¢:</span> 
                        <span style="color:#10b981; font-weight:bold; font-size:16px;">${parseFloat(user.balance || 0).toFixed(2)}</span> <span style="font-size:12px;">USDT</span>
                    </div>
                    <div class="user-date" style="font-size:11px; color:#cbd5e1; margin-top:4px;">
                        æ³¨å†Œæ—¶é—´: ${new Date(user.created_at).toLocaleString()}
                    </div>
                </div>
                
                <div style="display:flex; flex-direction:column; gap:8px; margin-top:5px;">
                     <button onclick="editBalance('${user.id}')" style="padding:6px 12px; font-size:12px; background:white; color:#3b82f6; border:1px solid #3b82f6; border-radius:6px; box-shadow:none;">
                        <i class="ri-money-dollar-circle-line"></i> ä½™é¢
                    </button>
                    <button onclick="initiateChat('${user.id}')" style="padding:6px 12px; font-size:12px; background:white; color:#8b5cf6; border:1px solid #8b5cf6; border-radius:6px; box-shadow:none;">
                        <i class="ri-message-3-line"></i> èŠå¤©
                    </button>
                    <button onclick="delUser('${user.id}')" style="padding:6px 12px; font-size:12px; background:white; color:#ef4444; border:1px solid #ef4444; border-radius:6px; box-shadow:none;">
                        <i class="ri-delete-bin-line"></i> åˆ é™¤
                    </button>
                </div>
            </div>
        `}).join('');
        
        if (filteredUsers.length === 0) {
            userList.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;">æš‚æ— ç”¨æˆ·æ•°æ®</div>';
        }
    }

    async function delUser(uid) {
        const res = await Swal.fire({
            title: 'ç¡®å®šæ°¸ä¹…åˆ é™¤ç”¨æˆ·?',
            text: "æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åˆ é™¤ç”¨æˆ·æ‰€æœ‰æ•°æ®ï¼",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'ç¡®å®šåˆ é™¤',
            cancelButtonText: 'å–æ¶ˆ'
        });

        if (res.isConfirmed) {
            try {
                await fetch(`${API_BASE}/api/admin/user/${uid}`, { 
                    method: 'DELETE', 
                    headers: getAuthHeaders() 
                });
                showNotification('æˆåŠŸ', 'ç”¨æˆ·å·²åˆ é™¤', 'success');
                refresh();
            } catch(e) {
                showNotification('é”™è¯¯', 'åˆ é™¤å¤±è´¥', 'danger');
            }
        }
    }

    // ================= 2. å°†ä»¥ä¸‹ä¸¤ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ° renderUsers å‡½æ•°çš„åé¢ =================

    // åŠŸèƒ½ï¼šåå°ä¿®æ”¹ç”¨æˆ·ä½™é¢ï¼ˆå¸¦å¼¹çª—åŠ¨ç”»ï¼‰
    async function editBalance(uid) {
        const { value: formValues } = await Swal.fire({
            title: 'ä¿®æ”¹ä½™é¢',
            html: `
                <div style="text-align:left; font-size:13px; color:#64748b; margin-bottom:5px;">ç›®æ ‡ç”¨æˆ· ID: ${uid}</div>
                <select id="swal-type" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px;">
                    <option value="add">â• å¢åŠ ä½™é¢ (å……å€¼)</option>
                    <option value="subtract">â– æ‰£é™¤ä½™é¢</option>
                    <option value="set">ğŸŸ° è®¾ç½®ä¸ºæŒ‡å®šé‡‘é¢</option>
                </select>
                <input id="swal-amount" type="number" step="0.01" placeholder="è¾“å…¥é‡‘é¢" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
            `,
            showCancelButton: true,
            confirmButtonColor: '#3b82f6',
            confirmButtonText: 'ä¿å­˜',
            cancelButtonText: 'å–æ¶ˆ',
            focusConfirm: false,
            preConfirm: () => {
                return {
                    type: document.getElementById('swal-type').value,
                    amount: document.getElementById('swal-amount').value
                }
            }
        });

        if (formValues && formValues.amount) {
            try {
                const res = await fetch(`${API_BASE}/api/admin/user/balance`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ userId: uid, ...formValues })
                });
                const d = await res.json();
                if(d.success) {
                    Swal.fire({ icon:'success', title:'ä¿®æ”¹æˆåŠŸ', timer:1500, showConfirmButton:false });
                    refresh(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    Swal.fire('å¤±è´¥', d.msg, 'error');
                }
            } catch(e) {
                Swal.fire('é”™è¯¯', 'ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error');
            }
        }
    }

    // åŠŸèƒ½ï¼šåå°å‘èµ·èŠå¤©ï¼ˆè‡ªåŠ¨è·³è½¬ï¼‰
    async function initiateChat(uid) {
        try {
            const res = await fetch(`${API_BASE}/api/admin/chat/initiate`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ userId: uid })
            });
            const d = await res.json();
            
            if(d.success) {
                // åˆ‡æ¢åˆ°èŠå¤©é¡µé¢
                nav('chat');
                showNotification('æˆåŠŸ', 'å·²å‘èµ·èŠå¤©ï¼Œæ­£åœ¨è·³è½¬...', 'success');
                // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ç­‰å¾…æ•°æ®åˆ·æ–°ï¼Œç„¶åè‡ªåŠ¨æ‰“å¼€è¯¥ç”¨æˆ·çš„èŠå¤©çª—å£
                setTimeout(() => {
                    const chatItem = document.querySelector(`.chat-list-item[onclick*="${d.sessionId}"]`);
                    if(chatItem) chatItem.click();
                }, 800);
            }
        } catch(e) {
            showNotification('é”™è¯¯', 'æ“ä½œå¤±è´¥', 'danger');
        }
    }

  // å•†å“ç®¡ç†åˆ—è¡¨æ¸²æŸ“
    function renderProdManage(list) {
        const container = document.getElementById('prod-list-manage');
        
        if (!list || list.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;">æš‚æ— å•†å“</div>';
            return;
        }
        
        container.innerHTML = list.map(p => {
            // å¤„ç†å›¾ç‰‡
            let imgHtml = '';
            try {
                const images = p.image_url ? JSON.parse(p.image_url) : [];
                if (images.length > 0) {
                    let firstImage = images[0];
                    if (!firstImage.startsWith('data:') && !firstImage.startsWith('http')) {
                        firstImage = `${API_BASE}${firstImage}`;
                    }
                    imgHtml = `<img src="${firstImage}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; margin-right:10px;">`;
                }
            } catch(e) {} 

            return `
            <div class="prod-row">
                <div style="flex:1; display:flex; align-items:center;">
                    ${imgHtml}
                    <div>
                        <div style="color:#0ea5e9; font-weight:bold;">${p.name}</div>
                        <div style="font-size:12px; color:#64748b;">
                            ${p.price} USDT | åº“å­˜:${p.stock} | ${p.category} 
                            ${p.is_pinned ? '| â˜…å·²ç½®é¡¶' : ''}
                        </div>
                    </div>
                </div>
                <div>
                    <button class="action-btn btn-pin" onclick="pinProd(${p.id})" title="${p.is_pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}">
                        <i class="ri-pushpin-${p.is_pinned ? 'fill' : 'line'}"></i> ${p.is_pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}
                    </button>
                    <button class="action-btn btn-edit" onclick='editProd(${JSON.stringify(p)})' title="ç¼–è¾‘">
                        <i class="ri-edit-line"></i> ç¼–è¾‘
                    </button>
                    <button class="action-btn btn-del" onclick="delProd(${p.id})" title="åˆ é™¤">
                        <i class="ri-delete-bin-line"></i> åˆ é™¤
                    </button>
                </div>
</div>
        `}).join('');
    }

    // [æ–°å¢] æ¸²æŸ“åˆ†ç±»æ’åºåˆ—è¡¨
    function renderCategorySort() {
        const container = document.getElementById('cat-sort-list');
        if (!curData.products) return;
        
        // æå–æ‰€æœ‰åˆ†ç±»
        const cats = [...new Set(curData.products.map(p => p.category))];
        
        container.innerHTML = cats.map(cat => `
            <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:8px 12px; border-radius:8px; display:flex; align-items:center; gap:8px;">
                <span style="font-weight:bold; color:#334155;">${cat}</span>
                <input type="number" placeholder="0" 
                    style="width:60px; margin:0; padding:4px; height:auto; text-align:center;"
                    onchange="updateCatPriority('${cat}', this.value)"
                >
            </div>
        `).join('');
    }

    // [æ–°å¢] ä¿å­˜åˆ†ç±»ä¼˜å…ˆçº§
    async function updateCatPriority(name, priority) {
        try {
            const res = await fetch(`${API_BASE}/api/admin/category/priority`, { 
                method: 'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify({ name, priority }) 
            });
            const d = await res.json();
            if(d.success) {
                showNotification('æˆåŠŸ', `åˆ†ç±» ${name} æ’åºå·²æ›´æ–°`, 'success');
            } else {
                showNotification('å¤±è´¥', d.msg, 'danger');
            }
        } catch(e) {
            showNotification('é”™è¯¯', 'ç½‘ç»œè¯·æ±‚å¤±è´¥', 'danger');
        }
    }

    function editProd(p) {
        document.getElementById('prod-title').innerHTML = `<i class="ri-edit-line"></i> ç¼–è¾‘å•†å“ (ID: ${p.id})`;
        document.getElementById('p-id').value = p.id;
        document.getElementById('p-name').value = p.name;
        document.getElementById('p-price').value = p.price;
        document.getElementById('p-stock').value = p.stock;
        document.getElementById('p-cat').value = p.category;
        document.getElementById('p-type').value = p.type || 'virtual';
        document.getElementById('p-desc').value = p.description || '';
        
        try {
            if(p.image_url) {
                tempImgs = JSON.parse(p.image_url);
            } else {
                tempImgs = [];
            }
        } catch(e) { 
            tempImgs = p.image_url ? [p.image_url] : []; 
        }
        
        renderImgPreviews();
        
        document.getElementById('btn-save-prod').innerHTML = '<i class="ri-check-line"></i> æ›´æ–°å•†å“';
        document.getElementById('btn-cancel-edit').style.display = 'inline-block';
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        window.scrollTo(0, 0);
    }

    function resetProdForm() {
        document.getElementById('prod-title').innerHTML = '<i class="ri-add-circle-line"></i> ä¸Šæ¶æ–°å•†å“';
        document.getElementById('p-id').value = "";
        document.getElementById('p-name').value = "";
        document.getElementById('p-price').value = "";
        document.getElementById('p-stock').value = "";
        document.getElementById('p-cat').value = "";
        document.getElementById('p-type').value = "virtual";
        document.getElementById('p-desc').value = "";
        tempImgs = [];
        renderImgPreviews();
        document.getElementById('btn-save-prod').innerHTML = '<i class="ri-check-line"></i> ä¸Šæ¶å•†å“';
        document.getElementById('btn-cancel-edit').style.display = 'none';
    }

    async function delProd(id) {
        if(!confirm('ç¡®å®šåˆ é™¤è¯¥å•†å“ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
        
        try {
            await fetch(`${API_BASE}/api/admin/product/${id}`, { 
                method: 'DELETE', 
                headers: getAuthHeaders() 
            });
            
            showNotification('æˆåŠŸ', 'å•†å“åˆ é™¤æˆåŠŸ', 'success');
            refresh();
        } catch (e) {
            showNotification('é”™è¯¯', 'åˆ é™¤å¤±è´¥', 'danger');
            console.error('åˆ é™¤å•†å“é”™è¯¯:', e);
        }
    }

    async function pinProd(id) {
        try {
            await fetch(`${API_BASE}/api/admin/product/pin/${id}`, { 
                method: 'POST', 
                headers: getAuthHeaders() 
            });
            
            showNotification('æˆåŠŸ', 'ç½®é¡¶çŠ¶æ€å·²æ›´æ–°', 'success');
            refresh();
        } catch (e) {
            showNotification('é”™è¯¯', 'æ“ä½œå¤±è´¥', 'danger');
            console.error('ç½®é¡¶å•†å“é”™è¯¯:', e);
        }
    }

// ================= èŠå¤©ç®¡ç† (æ–°ç‰ˆ) =================
    function renderChats() {
        const uList = document.getElementById('chat-users');
        const chats = curData.chats || {};
        
        const sessionIds = Object.keys(chats).sort((a, b) => {
            const timeA = chats[a].length ? new Date(chats[a][chats[a].length-1].created_at) : 0;
            const timeB = chats[b].length ? new Date(chats[b][chats[b].length-1].created_at) : 0;
            return timeB - timeA;
        });
        
        if (sessionIds.length === 0) {
            uList.innerHTML = '<div style="text-align:center; padding:60px 20px; color:#94a3b8;">æš‚æ— ä¼šè¯</div>';
            return;
        }
        
        uList.innerHTML = sessionIds.map(sid => {
            const messages = chats[sid] || [];
            const lastMsg = messages.length > 0 ? messages[messages.length-1] : { content: '...', created_at: new Date() };
            const unreadCount = messages.filter(m => m.sender === 'user' && !m.is_read).length;
            const timeStr = new Date(lastMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const uid = sid.replace('user_', '');
            
// ã€æ–°å¢ã€‘è·å–è¯¥ä¼šè¯çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¥æºï¼ˆç”¨æ¥åˆ¤æ–­æ˜¯å“ªä¸ªç½‘ç«™çš„å®¢æˆ·ï¼‰
            const source = messages[0]?.source || '';
            const sourceTag = source.includes('8888') ? ' [é¾å“¥]' : ' [Boss]';

            return `
            <div class="chat-item ${curChat === sid ? 'active' : ''}" onclick="openChat('${sid}')">
                <div class="chat-avatar">${uid.slice(-2)}</div>
                <div class="chat-info">
                    <div class="chat-top">
                        <span class="chat-name">UID ${uid} <span style="font-size:10px; color:${source.includes('8888')?'#d97706':'#2563eb'}">${sourceTag}</span></span>
                        <span class="chat-time">${timeStr}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="chat-preview">${lastMsg.content}</span>
                        ${unreadCount > 0 ? `<span class="chat-badge">${unreadCount}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    async function openChat(sid) {
        curChat = sid;
        
        // æ‰‹æœºç«¯åŠ¨ç”»ï¼šæ·»åŠ  active ç±»
        document.getElementById('chat-wrapper').classList.add('active');
       // ã€æ–°å¢ã€‘é”å®šèº«ä½“æ»šåŠ¨å’Œé«˜åº¦ï¼Œé˜²æ­¢é”®ç›˜å¼¹å‡ºå¼•èµ·çš„ä½ç§»
        if(window.innerWidth <= 768) {
            document.body.style.overflow = 'hidden';
            document.body.style.height = '100dvh'; // ä½¿ç”¨ dvh é€‚é…åŠ¨æ€è§†å£é«˜åº¦
        }
        
        const uid = sid.replace('user_', '');
        document.getElementById('chat-title-uid').innerText = `æ­£åœ¨å›å¤: UID ${uid}`;

        // 1. å‰ç«¯ç«‹å³æ¶ˆé™¤å°çº¢ç‚¹ (è§†è§‰ä¼˜åŒ–)
        if(curData.chats[sid]) {
            curData.chats[sid].forEach(m => {
                if(m.sender === 'user') m.is_read = true;
            });
        }
        renderChats(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥ç§»é™¤çº¢ç‚¹

        // 2. æ¸²æŸ“æ¶ˆæ¯
        renderMessages(sid);

        // 3. å‘Šè¯‰åç«¯æ ‡è®°å·²è¯» (è§£å†³åå¤å‡ºç°é—®é¢˜)
        try {
            await fetch(`${API_BASE}/api/admin/chat/read`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ sessionId: sid })
            });
        } catch(e) { console.error("æ ‡è®°å·²è¯»å¤±è´¥", e); }
    }

    function renderMessages(sid) {
        const msgs = curData.chats[sid] || [];
        const box = document.getElementById('chat-box');
        
        box.innerHTML = msgs.map(m => {
            const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isMe = m.sender === 'admin';
            
            let contentHtml = m.content;
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡ (æ ¹æ® msg_type æˆ– url åç¼€)
            if (m.msg_type === 'image' || (typeof m.content === 'string' && m.content.match(/\.(jpeg|jpg|gif|png|webp)$/i)) || (typeof m.content === 'string' && m.content.includes('cloudinary.com'))) {
                contentHtml = `<img src="${m.content}" style="max-width:100%; border-radius:8px; cursor:pointer;" onclick="window.open(this.src)">`;
            }

            return `
            <div class="msg-row ${isMe ? 'admin' : 'user'}">
                <div class="msg-bubble" style="${m.msg_type === 'image' || contentHtml.includes('<img') ? 'background:transparent; padding:0; box-shadow:none;' : ''}">
                    ${contentHtml}
                    <div class="msg-time" style="color:${isMe && !contentHtml.includes('<img') ?'rgba(255,255,255,0.7)':'#94a3b8'}">${time}</div>
                </div>
            </div>
        `}).join('');
        
        setTimeout(() => { box.scrollTop = box.scrollHeight; }, 50);
    }

    function closeChatMobile() {
        document.getElementById('chat-wrapper').classList.remove('active');
        curChat = null;
    }

    async function reply(btn) {
        if(!curChat) {
            showNotification('æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¢æˆ·', 'warning');
            return;
        }
        
        const t = document.getElementById('reply-in').value;
        if(!t.trim()) {
            showNotification('æç¤º', 'è¯·è¾“å…¥å›å¤å†…å®¹', 'warning');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<div class="loader" style="width:16px; height:16px; border-width:2px;"></div>';
        
        try {
            await fetch(`${API_BASE}/api/admin/reply`, { 
                method:'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify({ sessionId: curChat, text: t }) 
            });
            
            document.getElementById('reply-in').value = '';
            showNotification('æˆåŠŸ', 'å›å¤å·²å‘é€', 'success');
            refresh();
        } catch (e) {
            showNotification('é”™è¯¯', 'å‘é€å¤±è´¥', 'danger');
            console.error('å‘é€å›å¤é”™è¯¯:', e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-send-plane-fill"></i> å‘é€';
        }
    }

    // å›¾ç‰‡ä¸Šä¼ 
    async function uploadImg(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const fileName = file.name.toLowerCase();
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!fileName.match(/\.(jpeg|jpg|png|gif|webp)$/)) {
            showNotification('é”™è¯¯', 'åªæ”¯æŒ JPEG, PNG, GIF, WebP æ ¼å¼çš„å›¾ç‰‡', 'danger');
            input.value = '';
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å° (10MB)
        if (file.size > 10 * 1024 * 1024) {
            showNotification('é”™è¯¯', 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'danger');
            input.value = '';
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
        const uploadBtn = input.parentElement.querySelector('.file-upload-label');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.innerHTML = '<div class="loader" style="width:16px; height:16px; border-width:2px;"></div> ä¸Šä¼ ä¸­...';
        uploadBtn.style.pointerEvents = 'none';
        
        try {
            const res = await fetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                headers: {'Authorization': adminToken},
                body: formData
            });
            
            const d = await res.json();
            
            if(d.success) {
                tempImgs.push(d.url);
                renderImgPreviews();
                showNotification('æˆåŠŸ', 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
            } else {
                showNotification('é”™è¯¯', d.error || 'ä¸Šä¼ å¤±è´¥', 'danger');
            }
        } catch(e) { 
            showNotification('é”™è¯¯', 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'danger');
            console.error('ä¸Šä¼ å›¾ç‰‡é”™è¯¯:', e);
        } finally {
            input.value = '';
            uploadBtn.innerHTML = originalText;
            uploadBtn.style.pointerEvents = 'auto';
        }
    }
    
   // ä¸Šä¼ äºŒç»´ç 
    async function uploadQrcode(orderId, orderType = 'order') {
        const input = document.getElementById(`qrcode-${orderId}`);
        if (!input.files || !input.files[0]) return; // æ²¡é€‰æ–‡ä»¶ç›´æ¥è¿”å›
        
        const file = input.files[0];
        const fileName = file.name.toLowerCase();
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!fileName.match(/\.(jpeg|jpg|png|gif|webp)$/)) {
            showNotification('é”™è¯¯', 'åªæ”¯æŒå›¾ç‰‡æ ¼å¼', 'danger');
            input.value = '';
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > 10 * 1024 * 1024) {
            showNotification('é”™è¯¯', 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'danger');
            input.value = '';
            return;
        }

        // ä½¿ç”¨ SweetAlert è¿›è¡Œç¡®è®¤å’Œé¢„è§ˆ
        const reader = new FileReader();
        reader.onload = async function(e) {
            const { isConfirmed } = await Swal.fire({
                title: 'ç¡®è®¤ä¸Šä¼ æ”¶æ¬¾ç ?',
                html: `
                    <p style="font-size:13px; color:#64748b;">å°†ä¸Šä¼ è‡³è®¢å•: ${orderId}</p>
                    <img src="${e.target.result}" style="max-width:200px; max-height:200px; border-radius:8px; margin-top:10px; border:1px solid #e2e8f0;">
                `,
                showCancelButton: true,
                confirmButtonColor: '#0ea5e9',
                confirmButtonText: 'ç«‹å³ä¸Šä¼ ',
                cancelButtonText: 'å–æ¶ˆ',
                showLoaderOnConfirm: true,
                preConfirm: async () => {
                    const formData = new FormData();
                    formData.append('qrcode', file);
                    formData.append('orderId', orderId);
                    formData.append('orderType', orderType);
                    
                    try {
                        const res = await fetch(`${API_BASE}/api/admin/order/upload_qrcode`, {
                            method: 'POST',
                            headers: {'Authorization': adminToken},
                            body: formData
                        });
                        const d = await res.json();
                        if(!d.success) throw new Error(d.error || "ä¸Šä¼ å¤±è´¥");
                        return d;
                    } catch(error) {
                        Swal.showValidationMessage(`ä¸Šä¼ å¤±è´¥: ${error}`);
                    }
                }
            });

            if (isConfirmed) {
                Swal.fire({icon: 'success', title: 'ä¸Šä¼ æˆåŠŸ', timer: 1500, showConfirmButton: false});
                refresh();
            }
            // æ¸…ç©º input é˜²æ­¢é‡å¤è§¦å‘ change
            input.value = '';
        };
        reader.readAsDataURL(file);
    }

    function renderImgPreviews() {
        const container = document.getElementById('p-img-list');
        
        if (tempImgs.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; border:2px dashed #e2e8f0; border-radius:8px;">æš‚æ— å›¾ç‰‡</div>';
            return;
        }
        
      container.innerHTML = tempImgs.map((url, i) => {
            let fullUrl = url;
            if (!url.startsWith('data:') && !url.startsWith('http')) {
                fullUrl = `${API_BASE}${url}`;
            }
            return `
            <div class="img-preview-box">
                <img src="${fullUrl}" style="object-fit:cover;">
                <button class="img-preview-remove" onclick="tempImgs.splice(${i},1);renderImgPreviews()">Ã—</button>
            </div>
        `}).join('');
    }

    async function saveProd(btn) {
        const id = document.getElementById('p-id').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_BASE}/api/admin/product/${id}` : `${API_BASE}/api/admin/product`;

        // éªŒè¯è¡¨å•
        const name = document.getElementById('p-name').value.trim();
        const price = document.getElementById('p-price').value.trim();
        const stock = document.getElementById('p-stock').value;
        const category = document.getElementById('p-cat').value.trim();
        
        if (!name || !price || !stock || !category) {
            showNotification('é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'danger');
            return;
        }
        
        if (isNaN(parseFloat(price)) || parseFloat(price) <= 0) {
            showNotification('é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼', 'danger');
            return;
        }
        
        if (isNaN(parseInt(stock)) || parseInt(stock) < 0) {
            showNotification('é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„åº“å­˜æ•°é‡', 'danger');
            return;
        }

        btn.disabled = true; 
        btn.innerHTML = id ? '<div class="loader"></div> æ›´æ–°ä¸­...' : '<div class="loader"></div> ä¸Šæ¶ä¸­...';
        
        try {
            const response = await fetch(url, {
                method: method, 
                headers: getAuthHeaders(), 
                body: JSON.stringify({
                    name: name,
                    price: price,
                    stock: parseInt(stock),
                    category: category,
                    desc: document.getElementById('p-desc').value.trim(),
                    type: document.getElementById('p-type').value,
                    imageUrl: JSON.stringify(tempImgs)
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showNotification('æˆåŠŸ', id ? 'å•†å“æ›´æ–°æˆåŠŸ' : 'å•†å“ä¸Šæ¶æˆåŠŸ', 'success');
                if(!id) resetProdForm();
                refresh();
            } else {
                showNotification('é”™è¯¯', result.error || (id ? 'æ›´æ–°å¤±è´¥' : 'ä¸Šæ¶å¤±è´¥'), 'danger');
            }
        } catch(e) { 
            showNotification('é”™è¯¯', 'ç½‘ç»œé”™è¯¯: ' + e.message, 'danger');
            console.error('ä¿å­˜å•†å“é”™è¯¯:', e);
        } finally {
            btn.disabled = false; 
            btn.innerHTML = id ? '<i class="ri-check-line"></i> æ›´æ–°å•†å“' : '<i class="ri-check-line"></i> ä¸Šæ¶å•†å“';
        }
    }

    // æ‹›è˜ä¿¡æ¯ç®¡ç†
    function renderHireList(list) {
        const container = document.getElementById('h-list-container');
        container.innerHTML = '';
        
        if(!list || list.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">æš‚æ— æ‹›è˜ä¿¡æ¯</div>';
            return;
        }
        
        list.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'hire-item';
            div.innerHTML = `
                <div class="hire-del" onclick="this.parentElement.remove()">Ã—</div>
                <div class="form-group">
                    <label>èŒä½åç§°</label>
                    <input class="h-title" value="${item.title || ''}" placeholder="ä¾‹å¦‚ï¼šå®¢æœä¸“å‘˜">
                </div>
                <div class="form-group">
                    <label>èŒä½è¯¦æƒ…</label>
                    <textarea class="h-content" rows="3" placeholder="èŒä½æè¿°ã€è¦æ±‚ã€å¾…é‡ç­‰...">${item.content || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>è”ç³»æ–¹å¼</label>
                    <input class="h-contact" value="${item.contact || ''}" placeholder="ä¾‹å¦‚ï¼š@telegram_username">
                </div>
            `;
            container.appendChild(div);
        });
    }

    function addHireItem() {
        const container = document.getElementById('h-list-container');
        const div = document.createElement('div');
        div.className = 'hire-item';
        div.innerHTML = `
            <div class="hire-del" onclick="this.parentElement.remove()">Ã—</div>
            <div class="form-group">
                <label>èŒä½åç§°</label>
                <input class="h-title" placeholder="ä¾‹å¦‚ï¼šå®¢æœä¸“å‘˜">
            </div>
            <div class="form-group">
                <label>èŒä½è¯¦æƒ…</label>
                <textarea class="h-content" rows="3" placeholder="èŒä½æè¿°ã€è¦æ±‚ã€å¾…é‡ç­‰..."></textarea>
            </div>
            <div class="form-group">
                <label>è”ç³»æ–¹å¼</label>
                <input class="h-contact" placeholder="ä¾‹å¦‚ï¼š@telegram_username">
            </div>
        `;
        container.appendChild(div);
    }

    async function updHire(btn) {
        const items = document.querySelectorAll('.hire-item');
        const data = [];
        
        items.forEach(item => {
            const title = item.querySelector('.h-title').value.trim();
            const content = item.querySelector('.h-content').value.trim();
            const contact = item.querySelector('.h-contact').value.trim();
            
            if (title && content) {
                data.push({
                    title: title,
                    content: content,
                    contact: contact
                });
            }
        });
        
        if (data.length === 0) {
            showNotification('é”™è¯¯', 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæœ‰æ•ˆçš„æ‹›è˜èŒä½', 'danger');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> ä¿å­˜ä¸­...';
        
        try {
            await fetch(`${API_BASE}/api/admin/update/hiring`, { 
                method:'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify(data) 
            });
            
            showNotification('æˆåŠŸ', 'æ‹›è˜ä¿¡æ¯å·²ä¿å­˜', 'success');
        } catch (e) {
            showNotification('é”™è¯¯', 'ä¿å­˜å¤±è´¥', 'danger');
            console.error('ä¿å­˜æ‹›è˜ä¿¡æ¯é”™è¯¯:', e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-save-line"></i> ä¿å­˜æ‰€æœ‰æ‹›è˜ä¿¡æ¯';
        }
    }

    async function confirmPay(oid) {
        if(!confirm('ç¡®è®¤å·²æ”¶åˆ°è¯¥ç”¨æˆ·çš„å¾®ä¿¡/æ”¯ä»˜å®æ¬¾é¡¹ï¼Ÿ')) return;
        
        try {
            await fetch(`${API_BASE}/api/admin/confirm_pay`, { 
                method:'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify({ orderId: oid }) 
            });
            
            showNotification('æˆåŠŸ', 'è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºå·²æ”¯ä»˜', 'success');
            refresh();
        } catch(e) { 
            showNotification('é”™è¯¯', 'æ“ä½œå¤±è´¥', 'danger');
            console.error('ç¡®è®¤æ”¯ä»˜é”™è¯¯:', e);
        }
    }

    async function saveTrack(oid) {
        const num = document.getElementById(`track-${oid}`).value.trim();
        
        if (!num) {
            showNotification('é”™è¯¯', 'è¯·è¾“å…¥ç‰©æµå•å·', 'danger');
            return;
        }
        
        try {
            await fetch(`${API_BASE}/api/admin/order/ship`, { 
                method:'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify({ orderId: oid, trackingNumber: num }) 
            });
            
            showNotification('æˆåŠŸ', 'ç‰©æµä¿¡æ¯å·²ä¿å­˜', 'success');
            refresh();
        } catch(e) { 
            showNotification('é”™è¯¯', 'ä¿å­˜å¤±è´¥', 'danger');
            console.error('ä¿å­˜ç‰©æµä¿¡æ¯é”™è¯¯:', e);
        }
    }

async function updAnn(btn) {
        const announcement = document.getElementById('ann-text').value.trim();
        // [ä¿®æ”¹] è·å–ä¸‹æ‹‰æ¡†çš„å€¼(å­—ç¬¦ä¸²)ï¼Œä¸å†æ˜¯ checked
        const showPopup = document.getElementById('ann-pop').value;
        
        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> æ›´æ–°ä¸­...';
        
        try {
            // æ›´æ–°å…¬å‘Š
            await fetch(`${API_BASE}/api/admin/update/announcement`, { 
                method:'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify({ text: announcement }) 
            });
            
            // æ›´æ–°å¼¹çª—è®¾ç½®
            await fetch(`${API_BASE}/api/admin/update/popup`, { 
                method:'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify({ open: showPopup }) 
            });
            
            showNotification('æˆåŠŸ', 'è®¾ç½®å·²æ›´æ–°', 'success');
        } catch(e) { 
            showNotification('é”™è¯¯', 'æ›´æ–°å¤±è´¥', 'danger');
            console.error('æ›´æ–°è®¾ç½®é”™è¯¯:', e);
       } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-save-line"></i> æ›´æ–°è®¾ç½®';
        }
    }

   // åŠ è½½èµ„é‡‘æ˜ç»†
    async function loadBalanceLogs() {
        const container = document.getElementById('fund-list');
        const uid = document.getElementById('fund-user-search').value.trim();
        
        let url = `${API_BASE}/api/admin/balance_logs`;
        if (uid) url += `?userId=${uid}`;

        // ä¿®æ”¹ï¼šåªæœ‰å½“è¡¨æ ¼æ˜¯ç©ºçš„(ç¬¬ä¸€æ¬¡åŠ è½½)æ‰æ˜¾ç¤ºloadingï¼Œé˜²æ­¢è‡ªåŠ¨åˆ·æ–°æ—¶é—ªçƒ
        if (!container.innerHTML.trim() || container.innerText === 'åŠ è½½ä¸­...') {
             container.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#94a3b8;">åŠ è½½ä¸­...</td></tr>';
        }

        try {
            const res = await fetch(url, { headers: getAuthHeaders() });
            const logs = await res.json();
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#94a3b8;">æš‚æ— èµ„é‡‘è®°å½•</td></tr>';
                return;
            }

           container.innerHTML = logs.map(log => {
                const amount = parseFloat(log.amount);
                const isPlus = amount > 0;
                const color = isPlus ? '#10b981' : '#ef4444';
                // å¦‚æœæ˜¯åå°å……å€¼ä¸”ä¸ºè´Ÿæ•°(æ‰£æ¬¾)ï¼Œä¹Ÿæ˜¾ç¤ºçº¢è‰²
                const sign = isPlus ? '+' : '';
                const balanceDisplay = log.balance_after ? `<div style="font-size:10px; color:#94a3b8;">ä½™: ${parseFloat(log.balance_after)}</div>` : '';

                return `
                <tr>
                    <td style="color:#64748b; font-size:11px;">${new Date(log.created_at).toLocaleString()}</td>
                    <td>
                        <div style="font-weight:500; font-size:13px;">${escapeHtml(log.contact || 'æœªçŸ¥')}</div>
                        <div style="font-size:10px; color:#94a3b8;">${log.user_id}</div>
                    </td>
                    <td><span class="tag" style="background:#f1f5f9; color:#475569; font-size:11px; white-space:nowrap;">${log.type}</span></td>
                    <td>
                        <div style="color:${color}; font-weight:bold; font-family:monospace; font-size:14px;">${sign}${amount}</div>
                        ${balanceDisplay}
                    </td>
                    <td style="font-size:11px; color:#334155; min-width:100px;">${escapeHtml(log.remark)}</td>
                </tr>
            `}).join('');
        } catch (e) {
            console.error(e);
            container.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#ef4444;">æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
        }
    }

   // è‡ªåŠ¨åˆ·æ–° [å·²ä¿®æ”¹ï¼šåˆ é™¤è½®è¯¢ï¼Œæ”¹ä¸ºSocketç›‘å¬]
    // let refreshInterval = setInterval(refresh, 10000); 
    
    // åˆå§‹åŒ–
    if (adminToken) {
        refresh();
    }

    // [æ–°å¢] ç›‘å¬åç«¯å¹¿æ’­çš„æ›´æ–°äº‹ä»¶ï¼Œåªæœ‰æ•°æ®å˜åŠ¨æ—¶æ‰åˆ·æ–°
    socket.on('admin_update', () => { 
        console.log('æ£€æµ‹åˆ°æ•°æ®å˜åŠ¨ï¼Œè‡ªåŠ¨åˆ·æ–°...');
        refresh(); 
    });

    // [æ–°å¢] ç›‘å¬å…¶ä»–ç›¸å…³äº‹ä»¶ä½œä¸ºè¡¥å……
    socket.on('order_update', () => { refresh(); });
    socket.on('global_update', () => { refresh(); });
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            // å¯ä»¥æ·»åŠ å…³é—­æ¨¡æ€æ¡†çš„é€»è¾‘
        }
        
        if (e.key === 'r' && e.ctrlKey) {
            e.preventDefault();
            refresh();
        }
        
        if (e.key === 'l' && e.ctrlKey && e.shiftKey) {
            e.preventDefault();
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('login-modal').style.display = 'flex';
            showNotification('æç¤º', 'å·²é€€å‡ºç™»å½•', 'info');
        }
    });
    
    // é˜²æ­¢ç¦»å¼€é¡µé¢æ—¶ä¸¢å¤±æ•°æ®
    window.addEventListener('beforeunload', (e) => {
        // e.preventDefault();
        // e.returnValue = '';
    });

    // ================= æ–°å¢åŠŸèƒ½ =================

    // 1. åˆå§‹åŒ– Socket.io å®ç°å®æ—¶æ¶ˆæ¯
    

    socket.on('connect', () => {
        console.log("å·²è¿æ¥åˆ°å®æ—¶æœåŠ¡å™¨");
    });

    // ç›‘å¬æ–°æ¶ˆæ¯
    socket.on('new_message', (data) => {
        // å¦‚æœå½“å‰æ²¡æœ‰èŠå¤©æ•°æ®ï¼Œåˆå§‹åŒ–å®ƒ
        if (!curData.chats) curData.chats = {};
        if (!curData.chats[data.session_id]) curData.chats[data.session_id] = [];
        
        // æ·»åŠ æ¶ˆæ¯åˆ°æœ¬åœ°æ•°æ®
        curData.chats[data.session_id].push(data);

        // å¦‚æœå½“å‰æ­£å¥½æ‰“å¼€äº†è¿™ä¸ªä¼šè¯ï¼Œç›´æ¥è¿½åŠ æ¶ˆæ¯
        if (curChat === data.session_id) {
            const box = document.getElementById('chat-box');
            const time = new Date(data.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isMe = data.sender === 'admin';
            
            let contentHtml = data.content;
             if (data.msg_type === 'image' || (typeof data.content === 'string' && data.content.match(/\.(jpeg|jpg|gif|png|webp)$/i)) || (typeof data.content === 'string' && data.content.includes('cloudinary.com'))) {
                contentHtml = `<img src="${data.content}" style="max-width:100%; border-radius:8px; cursor:pointer;" onclick="window.open(this.src)">`;
            }

            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'admin' : 'user'}`;
            div.innerHTML = `
                <div class="msg-bubble" style="${data.msg_type === 'image' || contentHtml.includes('<img') ? 'background:transparent; padding:0; box-shadow:none;' : ''}">
                    ${contentHtml}
                    <div class="msg-time" style="color:${isMe && !contentHtml.includes('<img') ?'rgba(255,255,255,0.7)':'#94a3b8'}">${time}</div>
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            
            // æ ‡è®°ä¸ºå·²è¯»
            if(data.sender === 'user') {
                 fetch(`${API_BASE}/api/admin/chat/read`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ sessionId: data.session_id })
                });
            }
        } else {
            // å¦åˆ™æ’­æ”¾æç¤ºéŸ³æˆ–æ›´æ–°åˆ—è¡¨
            showNotification('æ–°æ¶ˆæ¯', `æ¥è‡ª ${data.session_id} çš„æ–°æ¶ˆæ¯`, 'info');
            renderChats(); // æ›´æ–°å·¦ä¾§åˆ—è¡¨é¢„è§ˆ
        }
        updateBadge(); // æ›´æ–°åº•éƒ¨çº¢ç‚¹
    });

    // æ›´æ–°åº•éƒ¨çº¢ç‚¹é€»è¾‘
    function updateBadge() {
        let totalUnread = 0;
        if(curData.chats) {
            Object.values(curData.chats).forEach(msgs => {
                totalUnread += msgs.filter(m => m.sender === 'user' && !m.is_read).length;
            });
        }
        const badge = document.getElementById('chat-badge-total');
        if(totalUnread > 0) {
            badge.style.display = 'block';
            badge.innerText = totalUnread > 99 ? '99+' : totalUnread;
        } else {
            badge.style.display = 'none';
        }
    }

    // è¦†ç›–åŸæœ‰çš„ renderChats ä»¥åŠ å…¥çº¢ç‚¹è®¡ç®—
    const originalRenderChats = renderChats;
    renderChats = function() {
        originalRenderChats();
        updateBadge();
    }
    
    // è¦†ç›–åŸæœ‰çš„ refresh ä»¥åŠ å…¥çº¢ç‚¹è®¡ç®—
    const originalRefresh = refresh;
    refresh = async function() {
        await originalRefresh();
        updateBadge();
    }

    // 2. å–æ¶ˆè®¢å•åŠŸèƒ½
    async function cancelOrderAdmin(oid) {
        const { value: reason } = await Swal.fire({
            title: 'ç¡®å®šå–æ¶ˆè®¢å•?',
            input: 'text',
            inputLabel: 'å–æ¶ˆåŸå›  (é€‰å¡«)',
            inputPlaceholder: 'ä¾‹å¦‚ï¼šç”¨æˆ·æœªä»˜æ¬¾',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'ç¡®å®šå–æ¶ˆ',
            cancelButtonText: 'ç‚¹é”™äº†'
        });

        if (reason !== undefined) { // ç‚¹å‡»äº†ç¡®å®š
            try {
                // è¿™é‡Œè°ƒç”¨åç«¯çš„å–æ¶ˆæ¥å£ï¼Œå¦‚æœåç«¯æ²¡æœ‰ä¸“é—¨çš„ç®¡ç†å‘˜å–æ¶ˆæ¥å£ï¼Œæˆ‘ä»¬ä½¿ç”¨é€šç”¨çš„çŠ¶æ€æ›´æ–°
                // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ä½ å¸Œæœ›å‰ç«¯æ˜¾ç¤ºâ€œå·²å–æ¶ˆâ€ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å»è§¦å‘æ•°æ®åº“å˜æ›´
                // ç”±äºä¸é‡å†™åç«¯ï¼Œæˆ‘ä»¬åˆ©ç”¨ backend ä¸­å·²æœ‰çš„ update é€»è¾‘æˆ–è€…å¤ç”¨å–æ¶ˆé€»è¾‘
                // å¦‚æœåç«¯æ²¡æœ‰ /api/admin/order/cancelï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ update status
                
               // è°ƒç”¨ç®¡ç†å‘˜ä¸“å±å–æ¶ˆæ¥å£
                const res = await fetch(`${API_BASE}/api/admin/order/cancel`, { 
                    method: 'POST', 
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ orderId: oid }) 
                });
                
                const d = await res.json();
                if(d.success) {
                    showNotification('æˆåŠŸ', 'è®¢å•å·²å–æ¶ˆ', 'success');
                    refresh();
                } else {
                    // å¦‚æœæ™®é€šæ¥å£å¤±è´¥ï¼ˆæ¯”å¦‚è®¢å•ä¸æ˜¯å¾…æ”¯ä»˜ï¼‰ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åç«¯æ”¯æŒå¼ºåˆ¶å–æ¶ˆã€‚
                    // ä½†æ ¹æ®ä½ çš„è¦æ±‚ï¼ˆåªæ”¹å‰ç«¯ï¼‰ï¼Œè¿™æ˜¯ç›®å‰æœ€å¥½çš„æ–¹æ¡ˆã€‚
                    showNotification('æç¤º', d.msg || 'æ“ä½œå®Œæˆ', 'info');
                    refresh();
                }
            } catch(e) {
                showNotification('é”™è¯¯', 'ç½‘ç»œè¯·æ±‚å¤±è´¥', 'danger');
            }
        }
    }

 // 3. ä¿®å¤ç§»åŠ¨ç«¯ä¾§æ»‘è¿”å›ä½“éªŒ
    // ä¿®æ”¹ closeChatMobileï¼Œå¢åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ
    function closeChatMobile() {
        const wrapper = document.getElementById('chat-wrapper');
        // ç§»é™¤ active classï¼Œé…åˆ CSS çš„ transition å®ç°ä¾§æ»‘å›å»
        wrapper.classList.remove('active');
        // ã€ä¿®æ”¹ã€‘å½»åº•æ¢å¤èº«ä½“æ»šåŠ¨å’Œé«˜åº¦è‡ªé€‚åº”
        document.body.style.overflow = 'auto';
        document.body.style.height = 'auto';
        curChat = null;
        renderChats(); // åˆ·æ–°åˆ—è¡¨çŠ¶æ€
    }

    // [æ–°å¢] æ‹¦æˆªåå°ç‰©ç†è¿”å›é”®
    window.addEventListener('popstate', (event) => {
        // å¦‚æœèŠå¤©çª—å£å¼€ç€ï¼Œå…³é—­èŠå¤©çª—å£
        const wrapper = document.getElementById('chat-wrapper');
        if (wrapper && wrapper.classList.contains('active')) {
            closeChatMobile();
            return; // é˜»æ­¢é»˜è®¤è¿”å›
        }
        // å¦‚æœæ˜¯å…¶ä»–å­é¡µé¢ï¼ˆé™¤äº†ä»ªè¡¨ç›˜ï¼‰ï¼Œè¿”å›ä»ªè¡¨ç›˜
        const activePage = document.querySelector('.page.active');
        if (activePage && activePage.id !== 'dash') {
            nav('dash');
        }
    });

    // æ¯æ¬¡å¯¼èˆªæ—¶æ¨å…¥å†å²è®°å½•ï¼Œç¡®ä¿æœ‰â€œè¿”å›â€çš„ä½™åœ°
    const originalNav = nav;
    nav = function(id) {
        originalNav(id);
        history.pushState({ page: id }, null, '');
    }
    
    // æ‰“å¼€èŠå¤©æ—¶ä¹Ÿæ¨å…¥è®°å½•
    const originalOpenChat = openChat;
    openChat = async function(sid) {
        await originalOpenChat(sid);
        history.pushState({ chat: sid }, null, '');
    }
</script>
</body>
</html>
